[buildout]
extensions = buildout-versions

extends =
#    buildout.d/settings.cfg

zeo-address = ${zeoserver-set:host}:${zeoserver-set:port}


parts =
    instance
    instance1
    instance2
    cmds
    mkdir-chameleon
    zopepy

[instance]
recipe = plone.recipe.zope2instance
user = ${zmi-set:user}:${zmi-set:pw}
effective-user = ${zope-set:os}
http-address = ${zope-set:port}
verbose-security = off
debug-mode = off
event-log-level = info
locales = ${buildout:directory}/locales
environment-vars =
    CHAMELEON_CACHE ${buildout:directory}/var/chameleon-cache
    CHAMELEON_DEBUG false
    CHAMELEON_RELOAD true
    CHAMELEON_EAGER true
    PYTHON_EGG_CACHE ${buildout:directory}/var/.python-eggs
    PTS_LANGUAGES en, es, pt-br
    zope_i18n_allowed_languages en, es, pt_BR
    zope_i18n_compile_mo_files false
    TEMP ${buildout:directory}/var/tmp
    TMP ${buildout:directory}/var/tmp
eggs =
    ${buildout:eggs}
zcml =
    ${buildout:zcml}

#configuracoes para usar o zeo
zeo-client = on
zeo-address = ${buildout:zeo-address}

# a configuracao abaixo deve ser on somente se a pasta com os blobs
# estiver compartilhada via rede (ex: nfs). Caso contrario, devera ser off
# e os arquivos serao enviados na mesma conexao do zeo.
shared-blob = on
# mesmo que a opcao acima seja off, devemos informar o caminho do blob-storage
# apesar de ser ignorado
blob-storage = ${buildout:blobs-dir}/var/blobstorage

[cmds]
recipe = plone.recipe.command
command =
    sed -i '/port-base/d' production.cfg
    sed -i '/127.0.0.1:/d; /instance/d; /${zope-set:host}:/d' ${buildout:directory}/etc/templates/haproxy.conf.in
    echo "  server instance${zope-set:instance1} ${zope-set:host}:${zope-set:instance1} cookie p${zope-set:instance1} check maxconn 2 rise 1" >> etc/templates/haproxy.conf.in
    echo "  server instance${zope-set:instance2} ${zope-set:host}:${zope-set:instance2} cookie p${zope-set:instance2} check maxconn 2 rise 1" >> etc/templates/haproxy.conf.in
    echo "  server instance${zope-set:instance3} ${zope-set:host}:${zope-set:instance3} cookie p${zope-set:instance3} check maxconn 2 rise 1" >> etc/templates/haproxy.conf.in
    chown -R ${zope-set:os} ${buildout:directory}
#
    mkdir -pv ${buildout:backups-dir}
    chown -R ${zope-set:os} ${buildout:backups-dir}
#
    mkdir -pv ${buildout:blobs-dir}/blobstorage_ditec_coced_idg
    chown -R ${zope-set:os} ${buildout:blobs-dir}/blobstorage_ditec_coced_idg
#
update-command = ${cmds:command}


[instance1]
<=instance
http-address = ${zope-set:host}:${zope-set:instance1}
icp-address = ${zope-set:host}:${zope-set:instance1}

[instance2]
<=instance
http-address = ${zope-set:host}:${zope-set:instance2}
icp-address = ${zope-set:host}:${zope-set:instance2}

[mkdir-chameleon]
recipe = plone.recipe.command
command =
    mkdir -p ${buildout:directory}/var/chameleon-cache
    rm -Rf ${buildout:directory}/var/chameleon-cache/*
update-command = ${:command}

[zopepy]
recipe = zc.recipe.egg
eggs = ${instance:eggs}
interpreter = zopepy
scripts = zopepy

